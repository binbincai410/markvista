# MarkVista 实现计划

本文档描述将要完成的工作，用于在开发前对齐理解。

---

## 一、项目是什么

- **名称**：MarkVista  
- **定位**：macOS 本地 Web Markdown 阅读工具，只读、不编辑  
- **运行**：`npm install` → `npm run dev` → 浏览器访问 localhost  

---

## 二、我会做哪些事

### 1. 初始化项目

- 使用 **React + Vite** 创建前端项目  
- 配置依赖：markdown-it、highlight.js、mermaid、svg-pan-zoom、html-to-image 等  
- 确保通过 `npm install` 和 `npm run dev` 可启动  

### 2. 文件加载

- 页面顶部提供 **「选择文件」** 按钮  
- 点击后打开系统文件选择器，仅支持选择单个 `.md` 文件  
- 读取文件内容后立即交给渲染逻辑，不提供文件夹浏览、目录树、多文件切换  
- 提供 **「刷新」** 按钮：在已选择过文件的前提下，点击后重新读取当前文件的磁盘内容并重新渲染，便于在外部修改文件后快速看到最新结果  
- **URL 持久化**：选择文件后，将文件内容存储到 `sessionStorage`（或 `localStorage`），并在 URL 中保存文件标识符（如 hash 参数 `#file=xxx`）。刷新页面时，自动从 URL 读取标识符并从存储中恢复文件内容，实现自动打开，无需重新选择文件  
- **章节位置记录**：在 URL 中记录当前查看的章节位置（如 hash 参数 `#heading=xxx`）。当用户滚动到某个标题时，自动更新 URL；刷新页面时，自动从 URL 读取章节标识符并滚动到对应位置，恢复阅读位置  

### 3. Markdown 渲染

- 使用 **markdown-it** 解析 Markdown，输出 HTML  
- 使用 **highlight.js** 做代码高亮  
- 支持：标题、列表、引用、表格、任务列表、代码块、行内代码、普通链接、图片（外链或 base64）  
- 渲染区域最大宽度 900px、居中、白底  

### 4. Mermaid 支持

- 识别正文中的 \`\`\`mermaid ... \`\`\` 代码块  
- 使用 **Mermaid 官方库** 将内容渲染为 **SVG**（不用 canvas）  
- 支持常见图类型（flowchart、sequence、class、state、er、gantt 等）  
- 渲染失败时在页面上显示错误提示，不导致页面崩溃  
- **字体大小**：Mermaid 图使用默认字体大小  

### 5. Mermaid 图预览与全屏

**正文内预览（文档流中）：**

- 每个 Mermaid 图在正文中**仅展示完整图**：自动适配宽度、完整可见，**不提供**缩放与拖拽  
- 避免在阅读时误触或遮挡正文，大图也能一眼看到全貌  
- 每个 Mermaid 图**右上角**提供两个按钮：
  - **「全屏」按钮**（⛶ 图标）：点击后该图进入全屏层
  - **「下载」按钮**（⬇ 图标）：点击后下载该图为 PNG 图片（2x 分辨率，文件名：`mermaid-{时间戳}.png`）

**全屏模式：**

- 点击全屏按钮后，该图进入**全屏层**（遮罩或新层覆盖整个视口）  
- 全屏内交互方式：
  - **两指移动**：拖动 Mermaid 图（平移 pan）
  - **三指移动**：缩小或放大 Mermaid 图（缩放 zoom，最小 0.5、最大 10）
  - 鼠标端：保留滚轮缩放、拖拽平移作为备选交互方式
- 全屏内提供关闭方式（如关闭按钮、ESC、点击空白处），退出后回到正文  
- 技术实现：全屏层内使用 **svg-pan-zoom**（或等效库）操作同一张 SVG，并添加触摸手势支持（如 hammer.js 或原生 touch 事件），保持清晰  

### 6. 导出 PDF

- 提供 **「导出 PDF」** 按钮  
- 使用浏览器 **window.print**，通过 CSS 控制打印样式  
- 整篇文档导出、所见即所得，包含已渲染的 Mermaid 图，默认 A4  

### 7. 导出 PNG 长图

- 提供 **「导出 PNG」** 按钮  
- 使用 **html-to-image**（或等效）导出**整篇文档**为一张 PNG 长图（非仅可视区域）  
- 默认 2x 分辨率，保证清晰  
- 文件名：原 Markdown 文件名 + 时间戳  
- 实现时：等待所有 Mermaid 渲染完成后再执行导出；内容区域不使用 overflow hidden，保证可完整截取  

### 8. 文档右侧章节导航

- 在**文档内容区域右侧**增加 **章节导航**（当前文档的标题大纲）  
- 根据渲染后的标题层级（如 h1、h2、h3）生成可点击的目录项，支持快速跳转到对应章节  
- 点击某一项时，页面滚动至该标题位置  
- 无文档或文档无标题时，导航可为空或隐藏  

### 9. UI 布局与风格

- **布局**：顶部一排按钮 [选择文件] [刷新] [导出 PDF] [导出 PNG]；下方为 Markdown 渲染区域，**右侧**为章节导航  
- **风格**：白色背景、内容区最大宽度 900px、居中、无深色模式、无复杂动画  

### 10. README

- 包含：安装依赖（npm install）、启动（npm run dev）、访问地址说明（如 http://localhost:xxxx）  

---

## 三、我不会做的事（与需求一致）

- Markdown 编辑  
- 文件夹浏览、目录树  
- 相对路径图片加载、Markdown 内部链接跳转  
- 多文件/多标签切换  
- 插件系统、批量导出、云端功能  
- 深色模式  

---

## 四、技术选型（计划使用）

| 用途           | 库/方案        |
|----------------|----------------|
| 框架 + 构建    | React + Vite   |
| Markdown 解析  | markdown-it    |
| 代码高亮       | highlight.js   |
| Mermaid 图     | mermaid        |
| 图缩放/平移（全屏内） | svg-pan-zoom   |
| 导出 PNG 长图  | html-to-image  |
| PDF            | window.print + CSS |

若有等效替代（如其他 pan-zoom 库），会保持「正文内完整显示、全屏内可缩放可平移、整篇导出」的同等效果。

---

## 五、非功能约定

- 可处理几千行 Markdown 文档（不刻意做分页，但避免卡死）  
- Mermaid 报错时仅提示错误，不崩溃  
- 导出 PDF/PNG 结果清晰、包含完整内容和 Mermaid 图  

---

## 六、验收自检（实现后会按此检查）

- [ ] 选择 .md 文件后，Markdown 正确渲染（含表格、代码块等）  
- [ ] 至少两个 Mermaid 图能正确显示  
- [ ] 正文内 Mermaid 图完整显示、无缩放/拖拽；每个图右上角有全屏和下载按钮；全屏内可缩放、可拖拽；下载功能正常（PNG，2x 分辨率）  
- [ ] 导出 PDF 正常、整篇、含图  
- [ ] 导出 PNG 为完整长图、2x、清晰  
- [ ] 右侧章节导航可点击并跳转到对应标题  
- [ ] URL 中记录章节位置，刷新后自动跳转回原位置  
- [ ] Mermaid 图文字大小比默认值增大约 30%  
- [ ] README 中有安装、启动、访问地址说明  

---

## 七、文档与后续

- 本文档（PLAN.md）用于对齐「要做/不做」的理解。  
- 若你希望调整某一条（例如增加/删减功能、改技术栈），直接指出，我会更新本文档再开始实现。  

---

**当前状态**：计划已写入，等待你确认或修改后再按此计划实现。
